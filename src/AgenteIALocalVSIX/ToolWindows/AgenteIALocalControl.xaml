<UserControl x:Class="AgenteIALocalVSIX.ToolWindows.AgenteIALocalControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes">

  <UserControl.Resources>
    <SolidColorBrush x:Key="HeaderBackgroundBrush" Color="#FF1E1E22" />
    <SolidColorBrush x:Key="HeaderHighEmphasisBrush" Color="#FFFFFFFF" />
    <SolidColorBrush x:Key="HeaderMediumEmphasisBrush" Color="#FF424242" />
    <Style x:Key="Text.Headline" TargetType="TextBlock">
      <Setter Property="FontSize" Value="22" />
      <Setter Property="FontWeight" Value="SemiBold" />
    </Style>
    <Style x:Key="Text.Subtitle" TargetType="TextBlock">
      <Setter Property="FontSize" Value="14" />
      <Setter Property="FontWeight" Value="SemiBold" />
    </Style>
    <Style x:Key="Text.Body" TargetType="TextBlock">
      <Setter Property="FontSize" Value="13" />
      <Setter Property="FontWeight" Value="Normal" />
    </Style>
    <Style x:Key="Text.Caption" TargetType="TextBlock">
      <Setter Property="FontSize" Value="12" />
      <Setter Property="FontWeight" Value="Normal" />
    </Style>
    <Style x:Key="IconButtonChromeStyle" TargetType="Button">
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="BorderBrush" Value="Transparent" />
      <Setter Property="BorderThickness" Value="0" />
      <Setter Property="Padding" Value="0" />
      <Setter Property="FocusVisualStyle" Value="{x:Null}" />
      <Setter Property="Foreground" Value="{StaticResource HeaderMediumEmphasisBrush}" />
      <Setter Property="RenderTransformOrigin" Value="0.5,0.5" />
      <Setter Property="OverridesDefaultStyle" Value="True" />
      <Setter Property="SnapsToDevicePixels" Value="True" />
      <Setter Property="materialDesign:RippleAssist.IsDisabled" Value="True" />
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="Button">
            <Border Background="{TemplateBinding Background}"
                    BorderBrush="{TemplateBinding BorderBrush}"
                    BorderThickness="{TemplateBinding BorderThickness}"
                    Padding="{TemplateBinding Padding}"
                    SnapsToDevicePixels="True">
              <Viewbox Stretch="Uniform" Width="18" Height="18">
                <ContentPresenter HorizontalAlignment="Center"
                                  VerticalAlignment="Center"
                                  RecognizesAccessKey="True" />
              </Viewbox>
             </Border>
           </ControlTemplate>
         </Setter.Value>
       </Setter>
      <Setter Property="RenderTransform">
        <Setter.Value>
          <ScaleTransform ScaleX="1" ScaleY="1" />
        </Setter.Value>
      </Setter>
      <Style.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
          <Setter Property="Background" Value="Transparent" />
          <Setter Property="Foreground" Value="{StaticResource HeaderHighEmphasisBrush}" />
          <Setter Property="RenderTransform">
            <Setter.Value>
              <ScaleTransform ScaleX="1.08" ScaleY="1.08" />
            </Setter.Value>
          </Setter>
        </Trigger>
        <Trigger Property="IsPressed" Value="True">
          <Setter Property="Background" Value="Transparent" />
          <Setter Property="RenderTransform">
            <Setter.Value>
              <ScaleTransform ScaleX="0.98" ScaleY="0.98" />
            </Setter.Value>
          </Setter>
        </Trigger>
      </Style.Triggers>
    </Style>
    <Style x:Key="PromptComboBoxStyle" TargetType="ComboBox">
      <Setter Property="Background" Value="{StaticResource HeaderBackgroundBrush}" />
      <Setter Property="Foreground" Value="{StaticResource HeaderHighEmphasisBrush}" />
      <Setter Property="BorderBrush" Value="{StaticResource HeaderMediumEmphasisBrush}" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="Padding" Value="10,4,10,4" />
    </Style>
  </UserControl.Resources>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!-- HEADER SECTION -->
    <Grid x:Name="HeaderContainer" Grid.Row="0" Height="64">
      <Border Margin="12,0,12,0"
              Padding="16,0,16,0"
              Background="{StaticResource HeaderBackgroundBrush}"
              BorderBrush="{StaticResource HeaderMediumEmphasisBrush}"
              BorderThickness="0,0,0,1">
        <Grid VerticalAlignment="Center">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <!-- Counters + State block -->
          <Grid Grid.Row="1"
                Grid.Column="0"
                Grid.ColumnSpan="2"
                Margin="0,4,24,0"
                VerticalAlignment="Center">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,8,0">
              <TextBlock Text="Solutions: "
                         Foreground="{StaticResource HeaderMediumEmphasisBrush}"
                         Style="{StaticResource Text.Body}" />
              <TextBlock x:Name="SolutionNameText"
                         Text="0"
                         Foreground="{StaticResource HeaderMediumEmphasisBrush}"
                         Style="{StaticResource Text.Body}" />
              <TextBlock Text="  " />
              <TextBlock Text="Projects: "
                         Foreground="{StaticResource HeaderMediumEmphasisBrush}"
                         Style="{StaticResource Text.Body}" />
              <TextBlock x:Name="ProjectCountText"
                         Text="0"
                         Foreground="{StaticResource HeaderMediumEmphasisBrush}"
                         Style="{StaticResource Text.Body}" />
            </StackPanel>

            <StackPanel Grid.Column="2"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Margin="8,0,0,0">
              <md:PackIcon x:Name="StateIcon"
                           Kind="{Binding StateIconKind}"
                           Width="20"
                           Height="20"
                           Foreground="{Binding StateColor}" />
              <TextBlock x:Name="StateLabelText"
                         Text="{Binding StateLabel}"
                         Margin="6,0,0,0"
                         Foreground="{Binding StateColor}"
                         Style="{StaticResource Text.Body}" />
            </StackPanel>
          </Grid>

          <!-- Actions block -->
          <StackPanel Grid.Row="1"
                      Grid.Column="2"
                      Orientation="Horizontal"
                      VerticalAlignment="Center">
            <Button x:Name="SettingsButton"
                    Width="32"
                    Height="32"
                    Style="{StaticResource IconButtonChromeStyle}"
                    Background="Transparent"
                    BorderBrush="Transparent"
                    BorderThickness="0"
                    Click="SettingsButton_Click">
              <md:PackIcon Kind="Cog"
                           Width="16"
                           Height="16"
                           Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
            </Button>
            <Button Width="32"
                    Height="32"
                    Margin="8,0,0,0"
                    Style="{StaticResource IconButtonChromeStyle}"
                    Background="Transparent"
                    BorderBrush="Transparent"
                    BorderThickness="0">
              <md:PackIcon Kind="HelpCircleOutline"
                           Width="16"
                           Height="16"
                           Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
            </Button>
          </StackPanel>
        </Grid>
      </Border>
    </Grid>

    <!-- BODY SECTION -->
    <Grid x:Name="BodyContainer" Grid.Row="1">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" MinHeight="0" />
        <RowDefinition Height="0" />
      </Grid.RowDefinitions>

      <!-- CHAT TOOLBAR (Items 7–9) -->
      <Grid x:Name="ChatToolbarGrid" Grid.Row="0" Height="48" Margin="12,0,12,8">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
          <ComboBox x:Name="ChatComboBox"
                    Width="260"
                    Height="32"
                    Padding="8,4,8,4"
                    SelectionChanged="ChatComboBox_SelectionChanged" />
          <Button x:Name="NewChatButton"
                  Width="32"
                  Height="32"
                  Margin="8,0,0,0"
                  Style="{StaticResource IconButtonChromeStyle}"
                  Background="Transparent"
                  BorderBrush="Transparent"
                  BorderThickness="0"
                  Click="NewChatButton_Click">
            <md:PackIcon Kind="Plus"
                         Width="16"
                         Height="16"
                         Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
          </Button>
        </StackPanel>

        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
          <Button x:Name="DeleteChatButton"
                  Width="32"
                  Height="32"
                  Style="{StaticResource IconButtonChromeStyle}"
                  Background="Transparent"
                  BorderBrush="Transparent"
                  BorderThickness="0"
                  Click="DeleteChatButton_Click">
            <md:PackIcon Kind="TrashCanOutline"
                         Width="16"
                         Height="16"
                         Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
          </Button>
        </StackPanel>
      </Grid>

      <!-- CHANGES ACCORDION (Items 10–13) -->
      <Expander Grid.Row="1"
                Margin="12,0,12,8"
                BorderThickness="1">
        <Expander.Header>
          <Grid x:Name="ChangesAccordionHeaderGrid"
                Height="36"
                VerticalAlignment="Center">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="12" />
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <md:PackIcon Grid.Column="0"
                         Kind="ChevronDown"
                         Width="14"
                         Height="14"
                         VerticalAlignment="Center" />

            <TextBlock Grid.Column="2"
                       Text="Changes (N)"
                       VerticalAlignment="Center"
                       Foreground="{StaticResource HeaderHighEmphasisBrush}"
                       Style="{StaticResource Text.Subtitle}" />

            <StackPanel Grid.Column="4"
                        Orientation="Horizontal"
                        VerticalAlignment="Center">
              <Button Width="28" Height="28"
                      Style="{StaticResource IconButtonChromeStyle}"
                      Background="Transparent"
                      BorderBrush="Transparent"
                      BorderThickness="0">
                <md:PackIcon Kind="ContentSave" Width="14" Height="14" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
              </Button>
              <Button Width="28" Height="28" Margin="8,0,0,0"
                      Style="{StaticResource IconButtonChromeStyle}"
                      Background="Transparent"
                      BorderBrush="Transparent"
                      BorderThickness="0">
                <md:PackIcon Kind="DeleteSweepOutline" Width="14" Height="14" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
              </Button>
              <Button Width="28" Height="28" Margin="8,0,0,0"
                      Style="{StaticResource IconButtonChromeStyle}"
                      Background="Transparent"
                      BorderBrush="Transparent"
                      BorderThickness="0">
                <md:PackIcon Kind="EraserVariant" Width="14" Height="14" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
              </Button>
            </StackPanel>
          </Grid>
        </Expander.Header>

        <ItemsControl Margin="12">
          <ItemsControl.Items>
            <TextBlock Text="src/App.xaml" Style="{StaticResource Text.Body}" />
            <TextBlock Text="src/Services/Runner.cs" Style="{StaticResource Text.Body}" />
            <TextBlock Text="tests/RunnerTests.cs" Style="{StaticResource Text.Body}" />
          </ItemsControl.Items>
        </ItemsControl>
      </Expander>

      <!-- CHAT SURFACE (single conversation history) -->
      <Border Grid.Row="2" Margin="0,8,0,8" Padding="12" BorderThickness="1" BorderBrush="{StaticResource HeaderMediumEmphasisBrush}" CornerRadius="4">
        <TextBox x:Name="ResponseJsonText"
                 AcceptsReturn="True"
                 IsReadOnly="True"
                 TextWrapping="Wrap"
                 VerticalScrollBarVisibility="Auto"
                 HorizontalScrollBarVisibility="Disabled"
                 Padding="16,12,16,12"
                 Background="{StaticResource HeaderBackgroundBrush}"
                 BorderThickness="0"
                 Foreground="{StaticResource HeaderHighEmphasisBrush}" />
      </Border>

      <!-- HIDDEN LOG OUTPUT (kept for functionality) -->
      <TextBox x:Name="LogText"
               Grid.Row="3"
               Visibility="Collapsed" />
    </Grid>

    <!-- PROMPT AREA (fixed bottom panel) -->
    <Grid x:Name="PromptAreaGrid" Grid.Row="2" Margin="12,8,12,0">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>

      <Grid Grid.Column="0" x:Name="PromptAndCombosGrid">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Margin="0,0,0,8">
          <TextBox x:Name="PromptTextBox"
                   Height="128"
                   MinHeight="128"
                   Padding="12,10,12,10"
                   VerticalContentAlignment="Center"
                   VerticalAlignment="Center"
                   AcceptsReturn="True"
                   TextWrapping="Wrap"
                   VerticalScrollBarVisibility="Auto"
                   HorizontalScrollBarVisibility="Disabled"
                   Background="{StaticResource HeaderBackgroundBrush}"
                   Foreground="{StaticResource HeaderHighEmphasisBrush}"
                   BorderBrush="{StaticResource HeaderMediumEmphasisBrush}"
                   BorderThickness="1"
                   TextAlignment="Left" />
          <TextBlock Text="Escribe tu consulta aquí, puedes presionar # para hacer referencia a un archivo de la solucion / proyecto"
                     Foreground="{StaticResource HeaderMediumEmphasisBrush}"
                     IsHitTestVisible="False"
                     Margin="16,14,16,0"
                     VerticalAlignment="Top"
                     TextWrapping="Wrap">
            <TextBlock.Style>
              <Style TargetType="TextBlock">
                <Setter Property="Visibility" Value="Collapsed" />
                <Style.Triggers>
                  <DataTrigger Binding="{Binding Text, ElementName=PromptTextBox}" Value="">
                    <Setter Property="Visibility" Value="Visible" />
                  </DataTrigger>
                  <DataTrigger Binding="{Binding Text, ElementName=PromptTextBox}" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Visible" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </TextBlock.Style>
          </TextBlock>
        </Grid>

        <Grid Grid.Row="1" Margin="0,0,0,8">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="12" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="12" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <ComboBox Grid.Row="0"
                    Grid.Column="0"
                    Width="120"
                    Height="32"
                    VerticalAlignment="Center"
                    Style="{StaticResource PromptComboBoxStyle}" />

          <ComboBox Grid.Row="0"
                    Grid.Column="2"
                    Width="160"
                    Height="32"
                    VerticalAlignment="Center"
                    Style="{StaticResource PromptComboBoxStyle}" />

          <ComboBox Grid.Row="0"
                    Grid.Column="4"
                    Width="120"
                    Height="32"
                    VerticalAlignment="Center"
                    Style="{StaticResource PromptComboBoxStyle}" />
        </Grid>
      </Grid>

      <Button Grid.Column="1"
              Grid.Row="0"
              Grid.RowSpan="2"
              Margin="12,0,0,0"
              VerticalAlignment="Center"
              Background="Transparent"
              BorderBrush="Transparent"
              BorderThickness="0"
              IsEnabled="{Binding RunButtonEnabled}"
               Click="RunButton_Click">
        <Button.Style>
          <Style TargetType="Button" BasedOn="{StaticResource IconButtonChromeStyle}">
            <Setter Property="Content">
              <Setter.Value>
                <md:PackIcon Kind="Send" Width="16" Height="16" Foreground="LimeGreen" />
              </Setter.Value>
            </Setter>
            <Style.Triggers>
              <DataTrigger Binding="{Binding StateLabel}" Value="Running">
                <Setter Property="Content">
                  <Setter.Value>
                    <md:PackIcon Kind="Stop" Width="16" Height="16" Foreground="IndianRed" />
                  </Setter.Value>
                </Setter>
              </DataTrigger>
            </Style.Triggers>
          </Style>
        </Button.Style>
       </Button>
    </Grid>

    <!-- SETTINGS PANEL (hidden overlay) -->
    <Border x:Name="SettingsPanel"
            Grid.RowSpan="3"
            HorizontalAlignment="Right"
            Margin="16"
            Padding="12"
            Width="300"
            Background="{DynamicResource {x:Static SystemColors.ControlLightBrushKey}}"
            BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
            BorderThickness="1"
            Visibility="Collapsed"
            Panel.ZIndex="1">
       <StackPanel>
         <TextBlock Text="Settings (active server)" Style="{StaticResource Text.Subtitle}" Margin="0,0,0,8" />

        <TextBlock Text="Active Server ID:" Style="{StaticResource Text.Body}" />
        <TextBox x:Name="ActiveServerIdTextBox" Margin="0,4,0,8" />

        <TextBlock Text="Base URL:" Style="{StaticResource Text.Body}" />
        <TextBox x:Name="ServerBaseUrlTextBox" Margin="0,4,0,8" />

        <TextBlock Text="Model:" Style="{StaticResource Text.Body}" />
        <TextBox x:Name="ServerModelTextBox" Margin="0,4,0,8" />

        <TextBlock Text="API Key:" Style="{StaticResource Text.Body}" />
        <TextBox x:Name="ServerApiKeyTextBox" Margin="0,4,0,8" />

        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
          <Button x:Name="SaveSettingsButton" Content="Save" Width="80" Click="SaveSettingsButton_Click" />
          <Button x:Name="CloseSettingsButton" Content="Close" Width="80" Margin="8,0,0,0" Click="CloseSettingsButton_Click" />
        </StackPanel>
      </StackPanel>
    </Border>

  </Grid>
</UserControl>
